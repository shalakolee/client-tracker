name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install MAUI workload
        run: dotnet workload install maui --skip-manifest-update

      - name: Publish (Windows)
        run: dotnet publish ClientTracker/ClientTracker.csproj -c Release -f net10.0-windows10.0.19041.0 -r win-x64

      - name: Package (Windows)
        id: meta
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $zip = "ClientTracker-win-x64-$tag.zip"
          $publish = "ClientTracker/bin/Release/net10.0-windows10.0.19041.0/win-x64/publish"
          if (!(Test-Path $publish)) { throw "Publish folder not found: $publish" }
          Compress-Archive -Path "$publish/*" -DestinationPath $zip -Force
          "artifact_name=$zip" >> $env:GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: ClientTracker-win-x64-*.zip

  build-android:
    runs-on: windows-latest
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install MAUI workload
        run: dotnet workload install maui --skip-manifest-update

      - name: Publish (Android APK)
        run: dotnet publish ClientTracker/ClientTracker.csproj -c Release -f net10.0-android /p:AndroidPackageFormat=apk

      - name: Collect APK
        id: meta
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $apk = Get-ChildItem -Recurse -Filter *.apk -Path ClientTracker/bin/Release/net10.0-android | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($null -eq $apk) { throw "No APK found" }
          $out = "ClientTracker-android-$tag.apk"
          Copy-Item $apk.FullName $out -Force
          "artifact_name=$out" >> $env:GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: ClientTracker-android-*.apk

  build-maccatalyst:
    runs-on: macos-latest
    outputs:
      artifact-name: ${{ steps.meta.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install MAUI workload
        run: dotnet workload install maui --skip-manifest-update

      - name: Publish (MacCatalyst)
        run: dotnet publish ClientTracker/ClientTracker.csproj -c Release -f net10.0-maccatalyst -r maccatalyst-x64

      - name: Package (MacCatalyst)
        id: meta
        shell: bash
        run: |
          tag="${GITHUB_REF_NAME}"
          publish="ClientTracker/bin/Release/net10.0-maccatalyst/maccatalyst-x64/publish"
          app=$(find "$publish" -maxdepth 1 -name "*.app" -print -quit)
          if [ -z "$app" ]; then
            echo "No .app found in $publish"
            exit 1
          fi
          zip="ClientTracker-maccatalyst-x64-${tag}.zip"
          ditto -c -k --sequesterRsrc --keepParent "$app" "$zip"
          echo "artifact_name=$zip" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: maccatalyst
          path: ClientTracker-maccatalyst-x64-*.zip

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-android, build-maccatalyst]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/ClientTracker-win-x64-*.zip
            dist/**/ClientTracker-android-*.apk
            dist/**/ClientTracker-maccatalyst-x64-*.zip

